---
title: macrotask 和 microtask
date: 2017-12-03 21:24:21
tags:
---

### 简介

一个事件循环(EventLoop)中会有一个正在执行的任务(Task)，而这个任务就是从 macrotask 队列中来的。在whatwg规范中有 queue 就是任务队列。当这个 macrotask 执行结束后所有可用的 microtask 将会在同一个事件循环中执行，当这些 microtask 执行结束后还能继续添加 microtask 一直到真个 microtask 队列执行结束。

### 渲染进程
浏览器包括4个进程：
1. 主进程（Browser进程），浏览器只有一个主进程负责资源下载，界面展示等主要基础功能
2. GPU进程，3D绘制
3. 第三方插件进程
4. 渲染进程（Render 进程），负责js的执行，页面渲染等功能
渲染进程主要包括：GUI渲染线程，Js引擎线程，事件循环线程，定时器线程，http异步线程。

### JS引擎线程
js引擎线程就是js内核，负责解析与执行js代码，也称为主线程。浏览器同时只能有一个JS引擎线程在运行JS程序，所以js是单线程运行的。
需要注意，js引擎线程和GUI渲染线程同时只能有一个工作，js引擎线程会阻塞GUI渲染线程

### 事件循环线程
事件循环线程用来管理控制事件循环，并且管理着一个事件队列（task queue），当js执行碰到事件绑定和一些异步操作时，会吧对应的事件添加到对应的线程中（比如定时器操作，便把定时器事件添加到定时器线程），等异步事件有了结果，便把他们的回调操作添加到事件队列中，等待js线程空闲来处理。

### 定时器线程
因为js是单线程运行，所以不能抽出事件来计时，只能另外开辟一个线程来处理定时器任务，等计时完成，把定时器要执行的操作添加到事件任务队列尾，等js线程来处理，这个线程就是定时器线程。

### 异步请求线程
当执行一个http异步请求时，便把异步请求事件添加到异步请求线程，等收到响应（http状态变化），把回调函数添加到事件队列，等待js引擎线程来处理。

### Event loop
js是单线程运行的，同步操作运行在js引擎主线程上，会形成一个执行栈，而异步操作则在他们对应的异步线程

### js运行过程

- 执行一个宏任务（栈中没有就从事件队列中获取）
- 执行过程中如果遇到微任务，就将它添加到微任务的任务队列中
- 宏任务执行完毕后，立即执行当前微任务队列中的所有微任务（依次执行）
- 当前宏任务执行完毕，开始检查渲染，然后GUI线程接管渲染
- 渲染完毕后，JS线程继续接管，开始下一个宏任务（从事件队列中获取）
